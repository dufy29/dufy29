<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> ⭐️CSAPP笔记 · Hexo</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="⭐️CSAPP笔记 - John Doe"><meta name="keywords"><meta name="author" content="John Doe"><link rel="short icon" href="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/favicon.ico"><link rel="stylesheet" href="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://example.com/atom.xml" title="Hexo"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul id="nav_list" class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div id="nav_btn" class="nav-btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">⭐️CSAPP笔记</h1><div class="post-info">2021-11-02</div><div class="post-content"><span id="more"></span>



<h2 id="Chap2-信息的表示和处理"><a href="#Chap2-信息的表示和处理" class="headerlink" title="Chap2: 信息的表示和处理"></a>Chap2: 信息的表示和处理</h2><p>计算机有自己的处理方式，我们若想利用好计算机，就要知道计算机是表示和处理信息的。计算机有一套自己的处理逻辑，采用二进制系统。</p>
<p>联想到在NLP 发展里程中，围绕自然语言的表示（one-hot–&gt;word2vec–&gt;bert等）也经历了不断的发展，好的表示有时会带来效果上巨大的跃升</p>
<p>历史上 <a target="_blank" rel="noopener" href="https://www.infoq.cn/article/p0kecufq5f9w_irxji3x">软件缺陷而引发的灾难</a> ：</p>
<ul>
<li><em>1996年6月4 日阿丽亚娜5号首次测试发射失败：</em></li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwzy1t88u6j30go0azdfw.jpg" alt="img"></p>
<ul>
<li><p><em>再举一个真实的例子， 纽约时报曾经报道，波音 787 的电力控制系统在 248 天电力不中断的状况下会自动关机（这可能发生在飞行途中），为此 FAA (美国联邦航空管理局) 告知航空公司，他们必须每隔 120 天进行一次维护重启，这显然是治标不治本的办法，我们来探究一下其中的真正原因：</em></p>
<blockquote>
<p>美国卡内基梅隆大学 (CMU) 的 <a target="_blank" rel="noopener" href="http://users.ece.cmu.edu/~koopman/">Phil Koopman</a> 教授指出，这其实是 integer overflow 问题，也就是所谓的整型溢出问题，原文链接在<a target="_blank" rel="noopener" href="https://betterembsw.blogspot.com/2015/05/counter-rollover-bites-boeing-787.html">这里</a>，我们简单小结一下，报告指出的248天为：248 days * 24 hours/day  * 60 minute/hour * 60 seconds/minute = 21427200秒，等效于2142720000（以1/100秒来计算），十六进制表示就是：0x7Fb75000 ，而最大的32位正整型是0x7FFFFFFF，248天看起来非常接近该限制，实际上，0x7FFFFFFF = 2147483647 /（24 * 60 * 60）= 24855/100 = 248.55天，因此，实际上崩溃会在248.55天之后发生，也就是说，使用了32位的有符号整型来记录时间（记录的单位是10ms），然后遇到溢出。</p>
</blockquote>
</li>
</ul>
<h3 id="原码、反码与补码"><a href="#原码、反码与补码" class="headerlink" title="原码、反码与补码"></a>原码、反码与补码</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/ComputerCode.html">原码, 反码, 补码 详解 </a></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx1yf53pabj30jw08smxk.jpg" alt="image-20211204175944888"></p>
<ul>
<li><strong>原码</strong></li>
</ul>
<p>第一位是符号位，其余位表示值。比如如果是8位二进制:</p>
<blockquote>
<p>[+1]原 = 0000 0001</p>
<p>[-1]原 = 1000 0001</p>
</blockquote>
<p>第一位是符号位. 因为第一位是符号位, 所以8位二进制数的取值范围就是:</p>
<blockquote>
<p>[1111 1111 , 0111 1111]</p>
</blockquote>
<p>即</p>
<blockquote>
<p>[-127 , 127]</p>
</blockquote>
<ul>
<li><strong>反码</strong></li>
</ul>
<p>正数的反码是其本身</p>
<p>负数的反码是在其原码的基础上, 符号位不变，其余各个位取反.</p>
<p>e.g.</p>
<blockquote>
<p>[+1] = [00000001]原 = [00000001]反</p>
<p>[-1] = [10000001]原 = [11111110]反</p>
</blockquote>
<p>反码还涉及 [ 循环进位] 的问题，比如我们来看看10进制的 (−1) 加上10进制的 (+2) 使用反码怎么运算。</p>
<pre><code>       二进制    十进制
    11111110     -1
 +  00000010     +2
............    ...
  1 00000000      0   &lt;-- 错误结果
           1     +1   &lt;-- 加上进位
............    ...
    00000001      1   &lt;-- 正确结果
</code></pre>
<p>反码的优点：正数和负数的加法都一样， 不需要单独判断符号的电路。但是，0表示还是不唯一</p>
<ul>
<li><strong>补码</strong></li>
</ul>
<p>正数的补码就是其本身</p>
<p>负数的补码是在其原码的基础上, 符号位不变, 其余各位取反, 最后+1. (<strong>即在反码的基础上+1</strong>)</p>
<blockquote>
<p>[+1] = [00000001]原 = [00000001]反 = [00000001]补</p>
<p>[-1] = [10000001]原 = [11111110]反 = [11111111]补</p>
</blockquote>
<p>补码转十进制值的两种方法：</p>
<p>1)按照定义</p>
<p>2)对于负数，从后往前，找到第一个1，然后，1左边的取反，得到原码，再取反即可</p>
<blockquote>
<p>e.g.， [1011]补 = -([0101]原)=-7</p>
</blockquote>
<p>补码表示的一个显著优点就是补码的减法可以通过补码加法来实现，即补码运算具有如下性质：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx37auybx8j30wk032mxa.jpg" alt="image-20211205195032550">而‐B补 可以通过将 B补“按位取反，末位加 1” 的法则进行计算。</p>
<p>e.g.</p>
<blockquote>
<p>计算 -3-3  </p>
<p>   1 0 1<br> - 0 1 1<br>-———<br>    1 0 1<br> + 1 0 1   &lt;—[-B]补<br>-———<br> 1 0 1 0  &lt;— -6</p>
</blockquote>
<ul>
<li><strong>乘法</strong></li>
</ul>
<p>乘法亦会转化为加法计算</p>
<p><em>参见龙芯团队书籍《计算机体系结构基础》p210:</em></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx371c2fimj3104054wf2.jpg" alt="image-20211205194326629"></p>
<p>图8.27给出两个 4 位补码相乘的例子。<strong>注意在补码加法运算中，需要进 行 8 位的符号位扩展，并仅保留 8 位结果。</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx36xtbzg9j31060fswg3.jpg" alt="image-20211205194001174"></p>
<p>知乎相关提问：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/22420697">补码乘法位级操作过程是这样的么？</a></p>
<ul>
<li>一些练习</li>
</ul>
<p>1） 整数比较判断（p75–习题2.44）</p>
<p>考虑 int x, y;  unsigned ux =x</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x&lt;<span class="number">0</span>		--&gt; ((x*<span class="number">2</span>)&lt;<span class="number">0</span>)   ❌</span><br><span class="line">ux &gt;<span class="number">-1</span>  							❌</span><br><span class="line">x&gt;y   --&gt;  -x &lt; -y    ❌</span><br><span class="line">x*x &gt;= <span class="number">0</span>  				    ❌</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x1 = INT_MIN;  <span class="comment">//最小值 1000....00</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;case1: x=%d, x*2=%d\n&quot;</span>, x1, x1*<span class="number">2</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> ux=<span class="number">5</span>;   <span class="comment">//有符号数会强制转为无符号数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;case2: ux&gt;-1: %d\n&quot;</span>, ux&gt;<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> x2=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> y= INT_MIN;  <span class="comment">// y相反数为自己，仍为最小数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;case3: x &gt;y: %d\n&quot;</span>, x2&gt;y);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;case3: -x&lt;-y: %d\n&quot;</span>, -x2&lt;-y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> x3=<span class="number">50000</span>;   <span class="comment">//溢出</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;case4: x*x: %d\n&quot;</span>, x3*x3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">case1: x=-2147483648, x*2=0</span><br><span class="line">case2: ux&gt;-1: 0</span><br><span class="line">case3: x &gt;y: 1</span><br><span class="line">case3: -x&lt;-y: 0</span><br><span class="line">case4: x*x: -1794967296</span><br></pre></td></tr></table></figure>

<p>2）Brian Kernighan（K&amp;R中的K，也是AWK的作者之一）在谈论<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1K64y1Q7Ru/">编程风格</a>的时候举了一个比特操作的例子：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx3eu127m6j31j40u0n0j.jpg" alt="image-20211206001313055"></p>
<p>3). 大小端</p>
<p>可以通过反汇编查看：<code>objdump -d /bin/ls</code></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx4iyvlo6dj313407qdim.jpg" alt="image-20211206232145903"></p>
<p>由上图可知，<code>C5</code>在低地址，所以为 小端表示</p>
<p>也可以通过字节序展示查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo_2:观察字节序的一个简单例子</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *pointer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show_bytes</span><span class="params">(pointer start, <span class="keyword">size_t</span> len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\t0x%.2x\n&quot;</span>,start+i, start[i]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0x01234567</span>;</span><br><span class="line">    show_bytes((pointer) &amp;a, <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">////////////////////////////</span></span><br><span class="line"><span class="number">0x7ffee697c8ac</span>	<span class="number">0x67</span></span><br><span class="line"><span class="number">0x7ffee697c8ad</span>	<span class="number">0x45</span></span><br><span class="line"><span class="number">0x7ffee697c8ae</span>	<span class="number">0x23</span></span><br><span class="line"><span class="number">0x7ffee697c8af</span>	<span class="number">0x01</span></span><br></pre></td></tr></table></figure>





<h3 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h3><p>1985年：IEEE-754 标准</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx4k4wfr9mj31e808it9l.jpg" alt="image-20211207000208368"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Demo_3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    assert(+<span class="number">0.</span> == <span class="number">-0.</span>);      <span class="comment">// 断言成功</span></span><br><span class="line">    assert(<span class="number">1.0</span>/+<span class="number">0.</span> == <span class="number">1.0</span>/<span class="number">-0.</span>); <span class="comment">// 断言失败</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体编码方式（32位浮点数为例）：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx4kbm3wvsj31600jg0ve.jpg" alt="image-20211207000838521"></p>
<p><strong>特别注意</strong>：浮点数加法和乘法不满足结合律 ，也不满足乘法对加法的分配律，以下举例说明：</p>
<p>(3.14+1e10)-1e10 = 0, 3.14+(1e10-1e10) = 3.14，(1e20 *1e20) * 1e-20= inf, 1e20 * (1e20 * 1e-20)= 1e20</p>
<p>1e20 * (1e20 - 1e20)= 0.0, 1e20 * 1e20 - 1e20 * 1e20 = NaN</p>
<p>这些特殊的数学性质对于科学计算程序员和编译器的优化限制都具有重要意义，举例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = a + b + c;</span><br><span class="line">y = b + c + d;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译器可能试图通过产生下列代码来省去一个浮点加法</span></span><br><span class="line">t = b + c;</span><br><span class="line">x = a + t;</span><br><span class="line">y = t + d;</span><br><span class="line"><span class="comment">// 但是对x来说，这个计算可能会产生于原始值不同的值,因为它使用了加法运算的不同结合方式</span></span><br></pre></td></tr></table></figure>

<p>问题理解：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有问题的版本 </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">float</span> sum = <span class="number">0.0f</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) sum += i + <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Sum: %f\n&quot;</span>, sum);  <span class="comment">// Sum: 50002896.000000</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1 + 2 + 3 + … + 10000 = 10000 * (10000 + 1) / 2 = 50005000 ?</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修正的版本</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">float</span> sum = <span class="number">0.0f</span>, corr = <span class="number">0.0f</span>; <span class="comment">/* corrective value for rounding error */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">float</span> y = (i + <span class="number">1</span>) - corr; <span class="comment">/* add the correction to specific item */</span></span><br><span class="line">      <span class="keyword">float</span> t = sum + y; <span class="comment">/* bits might be lost */</span></span><br><span class="line">      corr = (t - sum) - y; <span class="comment">/* recover lost bits */</span></span><br><span class="line">      sum = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sum: %f\n&quot;</span>, sum);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="datalab"><a href="#datalab" class="headerlink" title="datalab"></a>datalab</h3><p><a target="_blank" rel="noopener" href="https://github.com/flitdu/c-learning">个人github答案参考：</a>，</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/429163387">知乎记录的完成情况</a></p>
<p><a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/datalab.pdf">说明文件PDF：</a></p>
<blockquote>
<p>This directory contains the files that you will need to run the CS:APP<br>Data Lab, which helps develops the student’s understanding of bit<br>representations, two’s complement arithmetic, and IEEE floating point.</p>
</blockquote>
<ul>
<li>Docker 运行</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/82529114">Introduction to CSAPP（八）：Datalab</a></p>
<blockquote>
<p>用法详情还是需要你自己去阅读代码中的README文件，加油。总的来说，你需要做的是：</p>
<ol>
<li>阅读<code>bits.c</code>的注释与代码</li>
<li>修改它</li>
<li>命令行运行<code>./dlc -e bits.c</code>查看自己用了多少操作符，以及是否有代码风格问题</li>
<li>运行<code>make clean &amp;&amp; make btest</code>编译文件</li>
<li>运行<code>./btest</code>检查自己是否做对了</li>
<li>return 1 直到全部做完</li>
<li>最终运行<code>./driver.pl</code>获得打分</li>
</ol>
</blockquote>
<ul>
<li>isTmax()</li>
</ul>
<p>判断是否是补码最大值，注意<code>Test isTmax(-1[0xffffffff]) failed...</code>  特例的排除</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/59534845">CSAPP 之 DataLab详解，没有比这更详细的了</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * isTmax - returns 1 if x is the maximum, two&#x27;s complement number,</span></span><br><span class="line"><span class="comment"> *     and 0 otherwise </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | +</span></span><br><span class="line"><span class="comment"> *   Max ops: 10</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isTmax</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">  x max value is 01111...1111</span></span><br><span class="line"><span class="comment">  the destnitation is get all zero from x</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">int</span> i = x+<span class="number">1</span>; <span class="comment">// 10000...000</span></span><br><span class="line">  x = x+i;  <span class="comment">// 1111..111</span></span><br><span class="line">  x = ~x;  <span class="comment">// 000...000</span></span><br><span class="line">  <span class="comment">//exclude 111..111-------</span></span><br><span class="line">  <span class="comment">// attention int i=0000..000</span></span><br><span class="line">  i = !i;</span><br><span class="line">  x = x+i;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>isAsciiDigit()</li>
</ul>
<p>题目说明：若0x30&lt;=x&lt;=0x39（48&lt;=x&lt;=57），则返回1。<a target="_blank" rel="noopener" href="https://www.hegongshan.com/2021/05/06/csapp-1-data-lab/">《深入理解计算机系统》实验1.Data Lab</a></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxb4c1x52fj31840ii0wi.jpg" alt="image-20211212161418410"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters &#x27;0&#x27; to &#x27;9&#x27;)</span></span><br><span class="line"><span class="comment"> *   Example: isAsciiDigit(0x35) = 1.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x3a) = 0.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x05) = 0.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 15</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isAsciiDigit</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !((x &gt;&gt; <span class="number">3</span>) ^ <span class="number">0x6</span>) | !((x &gt;&gt; <span class="number">1</span>) ^ <span class="number">0x1c</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>isLessOrEqual() </li>
</ul>
<p>判断是否 &lt;=, <a target="_blank" rel="noopener" href="https://www.hegongshan.com/2021/05/06/csapp-1-data-lab/">《深入理解计算机系统》实验1.Data Lab</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isLessOrEqual</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sign_x = x &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">int</span> sign_y = y &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">int</span> is_different_sign = sign_x ^ sign_y;</span><br><span class="line">    <span class="keyword">int</span> negate_x = ~x + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> sign_y_minus_x = (y + negate_x) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">return</span> (!!(is_different_sign &amp; sign_x)) | ((!is_different_sign) &amp; (!sign_y_minus_x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>针对第一种情况，x&lt;0≤y，可以通过如下变换得到唯一为1 情况，然后取 2次 ! 变为 True</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxb6xvgjehj30pk0cyt9f.jpg" alt="image-20211212174427405"></p>
<ul>
<li>logicalNeg() </li>
</ul>
<p>题目说明：实现逻辑非!运算。<a target="_blank" rel="noopener" href="https://www.hegongshan.com/2021/05/06/csapp-1-data-lab/">《深入理解计算机系统》实验1.Data Lab</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * logicalNeg - implement the ! operator, using all of </span></span><br><span class="line"><span class="comment"> *              the legal operators except !</span></span><br><span class="line"><span class="comment"> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 4 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">logicalNeg</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((x | (~x + <span class="number">1</span>)) &gt;&gt; <span class="number">31</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="补充资料"><a href="#补充资料" class="headerlink" title="补充资料"></a>补充资料</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1a54y1k7YE?p=4">CMU教授的视频教程 - Lecture4：Floating Point</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1g5411K7Z7?p=17">计算机结构的伟大思想 - P17：浮点数运算</a> (40:00开始~)</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1554y1s7LS?p=27">台湾元智大学计算机组成原理：浮点数-1</a>，</p>
<p> <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1554y1s7LS?p=28">台湾元智大学计算机组成原理：浮点数-2</a> （中文讲解很清楚）</p>
<p>PS. 一个很有意思的介绍浮点数的网站：<a target="_blank" rel="noopener" href="https://0.30000000000000004.com/">https://0.30000000000000004.com</a></p>
<p>谷歌要花费力气来设计自己的BFloat16，详情请参考：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bfloat16_floating-point_format">Google BFloat16</a></p>
<ul>
<li>什么是有品位的程序？</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Cs411y7GQ?from=search&seid=13695301827862285580">Linus Torvalds 2016年TED采访</a>，14:26开始，拿出两个单向链表操作为例， 说明了什么是有品位的程序。 </p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx6p3o3clij31fg0u0jvz.jpg" alt="image-20211207234603349"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初学者版本</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_list_node</span><span class="params">(List *<span class="built_in">list</span>, Node *target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Node *prev = <span class="literal">NULL</span>;</span><br><span class="line">    Node *cur = <span class="built_in">list</span>-&gt;head;</span><br><span class="line">    <span class="comment">// Walk the list</span></span><br><span class="line">    <span class="keyword">while</span> (cur != target) &#123;</span><br><span class="line">        prev = cur;</span><br><span class="line">        cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Remove the target by updating the head or the previous node.</span></span><br><span class="line">    <span class="keyword">if</span> (!prev)</span><br><span class="line">        <span class="built_in">list</span>-&gt;head = target-&gt;next;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        prev-&gt;next = target-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 有品位的版本，消除特例，简单优雅的代码</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_list_node</span><span class="params">(List *<span class="built_in">list</span>, Node *target)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// The &quot;indirect&quot; pointer points to the *address*</span></span><br><span class="line">    <span class="comment">// of the thing we&#x27;ll update.</span></span><br><span class="line">    Node **indirect = &amp;<span class="built_in">list</span>-&gt;head;</span><br><span class="line">    <span class="comment">// Walk the list, looking for the thing that </span></span><br><span class="line">    <span class="comment">// points to the node we want to remove.</span></span><br><span class="line">    <span class="keyword">while</span> (*indirect != target)</span><br><span class="line">        indirect = &amp;(*indirect)-&gt;next;</span><br><span class="line">    *indirect = target-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>位操作计算strlen</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这可能是你的写strlen版本，看起来很精简，但是没有效率！</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">strlen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p = s;</span><br><span class="line">    <span class="keyword">while</span> (*p != ’\<span class="number">0</span>’) p++;</span><br><span class="line">    <span class="keyword">return</span> (p - s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>真是这样？让我们来看看 <a target="_blank" rel="noopener" href="https://opensource.apple.com/source/Libc/Libc-583/arm/string/strlen.s">Apple的strlen函数实现</a>，或者看看 <a target="_blank" rel="noopener" href="https://code.woboq.org/userspace/glibc/string/strlen.c.html">glibc的strlen函数实现</a></p>
<p>此外，请参看这个有意思的网页：<a target="_blank" rel="noopener" href="http://graphics.stanford.edu/~seander/bithacks.html">位运算的奇技淫巧：Bit Twiddling Hacks</a></p>
<ul>
<li>代码检查工具</li>
</ul>
<p><strong>静态检查工具</strong>：静态代码分析是指无需运行被测代码，通过词法分析、语法分析、控制流、数据流分析等技术对程序代码进行扫描，找出代码隐藏的错误和缺陷，比如未初始化，越界，死循环，代码不可达等，在整个软件开发生命周期中，30% 至 70% 的代码逻辑设计和编码缺陷是可以通过静态代码分析来发现和修复的，比如 <a target="_blank" rel="noopener" href="http://cppcheck.sourceforge.net/">Cppcheck</a>（开源免费），<a target="_blank" rel="noopener" href="https://www.synopsys.com/software-integrity/security-testing/static-analysis-sast.html">Coverity</a>，<a target="_blank" rel="noopener" href="https://www.perforce.com/products/klocwork">Klocwork</a>（商业收费）…</p>
<p><strong>动态检查工具</strong>，比如 <a target="_blank" rel="noopener" href="https://valgrind.org/">Valgrind</a>，它是用于构建动态分析工具的探测框架，它包括一个工具集，每个工具执行某种类型的调试、分析或类似的任务，以帮助完善你的程序，比如memory check，Cache miss check …</p>
<p>PS. 一般会把上述的静态/动态检查工具整合到类似 <a target="_blank" rel="noopener" href="https://www.jenkins.io/">Jenkins</a> 这样的持续集成（CI）工具之中，代码一有改动就会触发其运行，然后直接观察和分析结果。</p>
<ul>
<li>安全编码规范</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://mirror.informatimago.com/next/developer.apple.com/documentation/Security/Conceptual/SecureCodingGuide/SecureCodingGuide.pdf">Apple Secure Coding Guide</a></p>
<p><a target="_blank" rel="noopener" href="https://google.github.io/styleguide/cppguide.html">Google C++ Style Guide</a></p>
<p><a target="_blank" rel="noopener" href="https://ilcc.gitbooks.io/wiki/content/StyleGuide/Huawei-C/index.html">华为技术有限公司 C语言编程规范</a></p>
<p>![img](<a target="_blank" rel="noopener" href="https://fengmuzi2003.gitbook.io/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-MV9vJFv4kmvRLgEog6g%2F-MZLr4QZV6ey-NW43MqJ%2F-MZLu9NpSJs2LmyNovpv%2FProgramming-in-C">https://fengmuzi2003.gitbook.io/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-MV9vJFv4kmvRLgEog6g%2F-MZLr4QZV6ey-NW43MqJ%2F-MZLu9NpSJs2LmyNovpv%2FProgramming-in-C</a> bareilly_副本.jpg?alt=media&amp;token=e4a8c6d9-60f9-4d1e-810a-1d4478fbaf73)</p>
<p><a target="_blank" rel="noopener" href="https://www.bell-labs.com/usr/dmr/www/">https://www.bell-labs.com/usr/dmr/www/</a></p>
<h2 id="Chap3-程序的机器级表示"><a href="#Chap3-程序的机器级表示" class="headerlink" title="Chap3: 程序的机器级表示"></a>Chap3: 程序的机器级表示</h2><ul>
<li>汇编代码与机器代码</li>
</ul>
<p>对于源程序 xx.c，可以通过如下命令生成<strong>汇编代码</strong> <code>xx.s</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Og -S xx.c</span><br></pre></td></tr></table></figure>

<p>通过如下命令生成二进制格式的<strong>目标代码</strong><code>xx.o</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Og -c xx.c</span><br></pre></td></tr></table></figure>

<p>通过反汇编命令<code>objdump</code>可以将机器代码翻译成汇编代码,查看 .o 文件内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d xx.o</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0000000000000000 &lt;multstore&gt;:</span><br><span class="line">   0:	f3 0f 1e fa          	endbr64 </span><br><span class="line">   4:	53                   	push   %rbx</span><br><span class="line">   5:	48 89 d3             	mov    %rdx,%rbx</span><br><span class="line">   8:	e8 00 00 00 00       	callq  d &lt;multstore+0xd&gt;</span><br><span class="line">   d:	48 89 03             	mov    %rax,(%rbx)</span><br><span class="line">  10:	5b                   	pop    %rbx</span><br><span class="line">  11:	c3                   	retq   </span><br></pre></td></tr></table></figure>

<ul>
<li>x86-64通用目的寄存器</li>
</ul>
<p>用于存储整数数据和指针</p>
<p>更多寄存器 知识参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/272135463">一口气看完45个寄存器，CPU核心技术大揭秘</a></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxn0w0gug6j30u00yh79p.jpg" alt="image-20211222232137445"></p>
<p>其中，调用者、被调用者保存寄存器分类如下：</p>
<table>
<thead>
<tr>
<th>调用者保存寄存器</th>
<th>其余</th>
</tr>
</thead>
<tbody><tr>
<td>被调用者保存寄存器</td>
<td>%rbx ,%rbp,%r12~%r15</td>
</tr>
</tbody></table>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxn1f9t52xj31e60moq7a.jpg" alt="image-20211222234007914"></p>
<ul>
<li>操作数类型</li>
</ul>
<p>1）寄存器：%rax</p>
<p>2）内存引用：(%rax)</p>
<p>3）立即数: $8</p>
<h3 id="mov指令"><a href="#mov指令" class="headerlink" title="mov指令"></a>mov指令</h3><p>将数据从源位置**<u>复制</u>**到目的位置</p>
<p>mov 指令的后缀与寄存器的大小一定得是匹配的(e.g. ，movl 中l 表示4 bytes，而寄存器 %eax 的大小也是 4)：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxjfnvay8sj31960jy0vl.jpg" alt="image-20211219205032799"></p>
<p>c 语言数据类型在 x86-64中的大小：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxjfsqmt0qj30vw0d4q4g.jpg" alt="image-20211219205516203"></p>
<h3 id="push压栈指令"><a href="#push压栈指令" class="headerlink" title="push压栈指令"></a>push压栈指令</h3><p>e.g. 保存寄存器 rax 内存储的数据 0x123</p>
<p><code>pushq %rax</code></p>
<p>等价于如下两步：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subq $8, %rsp     // 寄存器rsp 值 -8，为待压入的值腾位置</span><br><span class="line">movq %rax, (%rsp)  // 将 寄存器rax 中值复制到新的栈顶位置</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxjijy64hmj313c0i0di0.jpg" alt="image-20211219223036575"></p>
<h3 id="pop出栈"><a href="#pop出栈" class="headerlink" title="pop出栈"></a>pop出栈</h3><p>同压栈操作类似，pop指令也可等效为如下两步</p>
<blockquote>
<p>注意，pop后，内存地址 0x100中保存的数据 0x123依旧存在</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxjiskjxg4j31220hgjte.jpg" alt="image-20211219223853989"></p>
<h3 id="cmpq指令"><a href="#cmpq指令" class="headerlink" title="cmpq指令"></a>cmpq指令</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">comp</span><span class="params">(<span class="keyword">long</span> a, <span class="keyword">long</span> b)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (a==b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a in %rdi, b in %rsi</span><br><span class="line">  cmp    %rsi,%rdi   (a-b) 设置条件码寄存器</span><br><span class="line">  sete   %al</span><br><span class="line">  movzbl %al,%eax</span><br><span class="line">  retq</span><br></pre></td></tr></table></figure>

<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxko67rt12j313i0fagnn.jpg" alt="image-20211220223031369"></p>
<h3 id="栈帧-函数调用"><a href="#栈帧-函数调用" class="headerlink" title="栈帧-函数调用"></a>栈帧-函数调用</h3><p>综合以下文章理解之：</p>
<p>🔥<a target="_blank" rel="noopener" href="https://gitbook.coder.cat/function-call-principle/">函数调用原理</a></p>
<blockquote>
<p>这是一篇讲述函数调用原理的文章，通过大量的示意图从比较基础的概念开始阐述函数调用时堆栈的完整变化过程，同时还会通过具体例子来分析在X-64平台上函数调用在汇编级的表示，从而深刻理解函数调用原理。最后会提供几个例子来发现C语言函数栈帧的一些有意思的行为</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://ctfbook.ph0en1x.com/reverse/zhan-3001-zhan-zheng-yu-han-shu-diao-yong"><strong>栈、栈帧与函数调用</strong></a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017151354">函数栈的实现原理</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sddai/p/9762968.html">C函数调用过程原理及函数栈帧分析</a></p>
<p>程序执行时，Linux 会为其在内存中分配相应的空间以支撑程序的运行，如下图所示：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxrky2ndd3j316y0gewgr.jpg" alt="image-20211226215745237"></p>
<p>在虚拟内存中，内存空间被分为多个区域。代码指令保存在文本段，已初始化的全局变量 <code>global</code> 保存在数据段，程序运行中动态申请的内存<code>malloc(10 * char())</code>放在堆中，而函数执行的时候则在栈中开辟空间运行。例如<code>main</code>函数便占有一个函数栈，其中的变量<code>i</code>和<code>ip</code>都保存在<code>main</code>的栈空间中。</p>
<p>函数的栈空间有个名字叫做 <code>栈帧</code> (stack frame）</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxrl7exqwij311w0lcq5c.jpg" alt="image-20211226220645984"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1DA411Y7jk?p=4">CS50：P4第3周 C语言 字符串 指针 内存管理1:51</a>  讲解交互变量值</p>
<h3 id="递归调用"><a href="#递归调用" class="headerlink" title="递归调用"></a>递归调用</h3><p>B站视频讲解：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cD4y1D7uR?p=19">p19- 过程函数调用 07:00</a> </p>
<h3 id="缓冲区溢出"><a href="#缓冲区溢出" class="headerlink" title="缓冲区溢出"></a>缓冲区溢出</h3><p>of 为overflow.c的可执行文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">echo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">4</span>];   <span class="comment">// stored on the stack</span></span><br><span class="line">  gets(buf);</span><br><span class="line">  <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;type a string:&quot;</span>);</span><br><span class="line">  echo();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试查看地址：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb of</span><br><span class="line">b overflow.c:5  # 设置断点</span><br><span class="line">r					# 运行</span><br><span class="line">info f   # 打印栈信息</span><br><span class="line">p/a &amp;buf[0]  # 查看 buf地址</span><br></pre></td></tr></table></figure>

<h3 id="bomb-lab"><a href="#bomb-lab" class="headerlink" title="bomb lab"></a>bomb lab</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/104130161">Introduction to CSAPP（十九）：这可能是你能找到的分析最全的Bomblab了</a></p>
<p>bomb.c 内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***************************************************************************</span></span><br><span class="line"><span class="comment"> * Dr. Evil&#x27;s Insidious Bomb, Version 1.1</span></span><br><span class="line"><span class="comment"> * Copyright 2011, Dr. Evil Incorporated. All rights reserved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * LICENSE:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Dr. Evil Incorporated (the PERPETRATOR) hereby grants you (the</span></span><br><span class="line"><span class="comment"> * VICTIM) explicit permission to use this bomb (the BOMB).  This is a</span></span><br><span class="line"><span class="comment"> * time limited license, which expires on the death of the VICTIM.</span></span><br><span class="line"><span class="comment"> * The PERPETRATOR takes no responsibility for damage, frustration,</span></span><br><span class="line"><span class="comment"> * insanity, bug-eyes, carpal-tunnel syndrome, loss of sleep, or other</span></span><br><span class="line"><span class="comment"> * harm to the VICTIM.  Unless the PERPETRATOR wants to take credit,</span></span><br><span class="line"><span class="comment"> * that is.  The VICTIM may not distribute this bomb source code to</span></span><br><span class="line"><span class="comment"> * any enemies of the PERPETRATOR.  No VICTIM may debug,</span></span><br><span class="line"><span class="comment"> * reverse-engineer, run &quot;strings&quot; on, decompile, decrypt, or use any</span></span><br><span class="line"><span class="comment"> * other technique to gain knowledge of and defuse the BOMB.  BOMB</span></span><br><span class="line"><span class="comment"> * proof clothing may not be worn when handling this program.  The</span></span><br><span class="line"><span class="comment"> * PERPETRATOR will not apologize for the PERPETRATOR&#x27;s poor sense of</span></span><br><span class="line"><span class="comment"> * humor.  This license is null and void where the BOMB is prohibited</span></span><br><span class="line"><span class="comment"> * by law.</span></span><br><span class="line"><span class="comment"> ***************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;support.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;phases.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * Note to self: Remember to erase this file so my victims will have no</span></span><br><span class="line"><span class="comment"> * idea what is going on, and so they will all blow up in a</span></span><br><span class="line"><span class="comment"> * spectaculary fiendish explosion. -- Dr. Evil </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">FILE *infile;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *input;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Note to self: remember to port this bomb to Windows and put a </span></span><br><span class="line"><span class="comment">     * fantastic GUI on it. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When run with no arguments, the bomb reads its input lines </span></span><br><span class="line"><span class="comment">     * from standard input. */</span></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;  </span><br><span class="line">	infile = <span class="built_in">stdin</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When run with one argument &lt;file&gt;, the bomb reads from &lt;file&gt; </span></span><br><span class="line"><span class="comment">     * until EOF, and then switches to standard input. Thus, as you </span></span><br><span class="line"><span class="comment">     * defuse each phase, you can add its defusing string to &lt;file&gt; and</span></span><br><span class="line"><span class="comment">     * avoid having to retype it. */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (argc == <span class="number">2</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!(infile = fopen(argv[<span class="number">1</span>], <span class="string">&quot;r&quot;</span>))) &#123;</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">&quot;%s: Error: Couldn&#x27;t open %s\n&quot;</span>, argv[<span class="number">0</span>], argv[<span class="number">1</span>]);</span><br><span class="line">	    <span class="built_in">exit</span>(<span class="number">8</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* You can&#x27;t call the bomb with more than 1 command line argument. */</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s [&lt;input_file&gt;]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Do all sorts of secret stuff that makes the bomb harder to defuse. */</span></span><br><span class="line">    initialize_bomb();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Welcome to my fiendish little bomb. You have 6 phases with\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;which to blow yourself up. Have a nice day!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Hmm...  Six phases must be more secure than one phase! */</span></span><br><span class="line">    input = read_line();             <span class="comment">/* Get input                   */</span></span><br><span class="line">    phase_1(input);                  <span class="comment">/* Run the phase               */</span></span><br><span class="line">    phase_defused();                 <span class="comment">/* Drat!  They figured it out!</span></span><br><span class="line"><span class="comment">				      * Let me know how they did it. */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Phase 1 defused. How about the next one?\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The second phase is harder.  No one will ever figure out</span></span><br><span class="line"><span class="comment">     * how to defuse this... */</span></span><br><span class="line">    input = read_line();</span><br><span class="line">    phase_2(input);</span><br><span class="line">    phase_defused();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;That&#x27;s number 2.  Keep going!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* I guess this is too easy so far.  Some more complex code will</span></span><br><span class="line"><span class="comment">     * confuse people. */</span></span><br><span class="line">    input = read_line();</span><br><span class="line">    phase_3(input);</span><br><span class="line">    phase_defused();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Halfway there!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Oh yeah?  Well, how good is your math?  Try on this saucy problem! */</span></span><br><span class="line">    input = read_line();</span><br><span class="line">    phase_4(input);</span><br><span class="line">    phase_defused();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;So you got that one.  Try this one.\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Round and &#x27;round in memory we go, where we stop, the bomb blows! */</span></span><br><span class="line">    input = read_line();</span><br><span class="line">    phase_5(input);</span><br><span class="line">    phase_defused();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Good work!  On to the next...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This phase will never be used, since no one will get past the</span></span><br><span class="line"><span class="comment">     * earlier ones.  But just in case, make this one extra hard. */</span></span><br><span class="line">    input = read_line();</span><br><span class="line">    phase_6(input);</span><br><span class="line">    phase_defused();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Wow, they got it!  But isn&#x27;t something... missing?  Perhaps</span></span><br><span class="line"><span class="comment">     * something they overlooked?  Mua ha ha ha ha! */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Phase_1 秘密藏在 $0x402400</p>
<blockquote>
<p>Border relations with Canada have never been better.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0000000000400ee0 &lt;phase_1&gt;:</span><br><span class="line">  400ee0:	48 83 ec 08          	sub    $0x8,%rsp</span><br><span class="line">  400ee4:	be 00 24 40 00       	mov    $0x402400,%esi   &lt;--- 藏在这个地址里</span><br><span class="line">  400ee9:	e8 4a 04 00 00       	callq  401338 &lt;strings_not_equal&gt;</span><br><span class="line">  400eee:	85 c0                	test   %eax,%eax</span><br><span class="line">  400ef0:	74 05                	je     400ef7 &lt;phase_1+0x17&gt;</span><br><span class="line">  400ef2:	e8 43 05 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400ef7:	48 83 c4 08          	add    $0x8,%rsp</span><br><span class="line">  400efb:	c3                   	retq   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Phase_2 是在计算一个 等比数列：1 2 4 8 16 32</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0000000000400efc &lt;phase_2&gt;:</span><br><span class="line">  400efc:	55                   	push   %rbp</span><br><span class="line">  400efd:	53                   	push   %rbx</span><br><span class="line">  400efe:	48 83 ec 28          	sub    $0x28,%rsp</span><br><span class="line">  400f02:	48 89 e6             	mov    %rsp,%rsi</span><br><span class="line">  400f05:	e8 52 05 00 00       	callq  40145c &lt;read_six_numbers&gt;</span><br><span class="line">  400f0a:	83 3c 24 01          	cmpl   $0x1,(%rsp)</span><br><span class="line">  400f0e:	74 20                	je     400f30 &lt;phase_2+0x34&gt;</span><br><span class="line">  400f10:	e8 25 05 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f15:	eb 19                	jmp    400f30 &lt;phase_2+0x34&gt;</span><br><span class="line">  400f17:	8b 43 fc             	mov    -0x4(%rbx),%eax</span><br><span class="line">  400f1a:	01 c0                	add    %eax,%eax</span><br><span class="line">  400f1c:	39 03                	cmp    %eax,(%rbx)</span><br><span class="line">  400f1e:	74 05                	je     400f25 &lt;phase_2+0x29&gt;</span><br><span class="line">  400f20:	e8 15 05 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f25:	48 83 c3 04          	add    $0x4,%rbx</span><br><span class="line">  400f29:	48 39 eb             	cmp    %rbp,%rbx</span><br><span class="line">  400f2c:	75 e9                	jne    400f17 &lt;phase_2+0x1b&gt;</span><br><span class="line">  400f2e:	eb 0c                	jmp    400f3c &lt;phase_2+0x40&gt;</span><br><span class="line">  400f30:	48 8d 5c 24 04       	lea    0x4(%rsp),%rbx</span><br><span class="line">  400f35:	48 8d 6c 24 18       	lea    0x18(%rsp),%rbp</span><br><span class="line">  400f3a:	eb db                	jmp    400f17 &lt;phase_2+0x1b&gt;</span><br><span class="line">  400f3c:	48 83 c4 28          	add    $0x28,%rsp</span><br><span class="line">  400f40:	5b                   	pop    %rbx</span><br><span class="line">  400f41:	5d                   	pop    %rbp</span><br><span class="line">  400f42:	c3                   	retq   </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">0000000000400f43 &lt;phase_3&gt;:</span><br><span class="line">  400f43:	48 83 ec 18          	sub    $0x18,%rsp</span><br><span class="line">  400f47:	48 8d 4c 24 0c       	lea    0xc(%rsp),%rcx</span><br><span class="line">  400f4c:	48 8d 54 24 08       	lea    0x8(%rsp),%rdx</span><br><span class="line">  400f51:	be cf 25 40 00       	mov    $0x4025cf,%esi</span><br><span class="line">  400f56:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">  400f5b:	e8 90 fc ff ff       	callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  400f60:	83 f8 01             	cmp    $0x1,%eax</span><br><span class="line">  400f63:	7f 05                	jg     400f6a &lt;phase_3+0x27&gt;</span><br><span class="line">  400f65:	e8 d0 04 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f6a:	83 7c 24 08 07       	cmpl   $0x7,0x8(%rsp)</span><br><span class="line">  400f6f:	77 3c                	ja     400fad &lt;phase_3+0x6a&gt;</span><br><span class="line">  400f71:	8b 44 24 08          	mov    0x8(%rsp),%eax</span><br><span class="line">  400f75:	ff 24 c5 70 24 40 00 	jmpq   *0x402470(,%rax,8)</span><br><span class="line">  400f7c:	b8 cf 00 00 00       	mov    $0xcf,%eax</span><br><span class="line">  400f81:	eb 3b                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400f83:	b8 c3 02 00 00       	mov    $0x2c3,%eax</span><br><span class="line">  400f88:	eb 34                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400f8a:	b8 00 01 00 00       	mov    $0x100,%eax</span><br><span class="line">  400f8f:	eb 2d                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400f91:	b8 85 01 00 00       	mov    $0x185,%eax</span><br><span class="line">  400f96:	eb 26                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400f98:	b8 ce 00 00 00       	mov    $0xce,%eax</span><br><span class="line">  400f9d:	eb 1f                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400f9f:	b8 aa 02 00 00       	mov    $0x2aa,%eax</span><br><span class="line">  400fa4:	eb 18                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400fa6:	b8 47 01 00 00       	mov    $0x147,%eax</span><br><span class="line">  400fab:	eb 11                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400fad:	e8 88 04 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400fb2:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">  400fb7:	eb 05                	jmp    400fbe &lt;phase_3+0x7b&gt;</span><br><span class="line">  400fb9:	b8 37 01 00 00       	mov    $0x137,%eax</span><br><span class="line">  400fbe:	3b 44 24 0c          	cmp    0xc(%rsp),%eax</span><br><span class="line">  400fc2:	74 05                	je     400fc9 &lt;phase_3+0x86&gt;</span><br><span class="line">  400fc4:	e8 71 04 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400fc9:	48 83 c4 18          	add    $0x18,%rsp</span><br><span class="line">  400fcd:	c3   </span><br></pre></td></tr></table></figure>



<h3 id="补充资料-1"><a href="#补充资料-1" class="headerlink" title="补充资料"></a>补充资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf">x64 Cheat Sheet</a> pdf</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxckpmarcqj30xp0u0wja.jpg" alt="image-20211213222625144"></p>
<p><strong>x86</strong>指令集自诞生以来指令数量的增长：</p>
<blockquote>
<p>From book:《RISC-V-Reader-Chinese-v2p1》</p>
</blockquote>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gy0j2omyq4j30v60f6q3z.jpg" alt="image-20220103154354439"></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1EW411u7th?p=7">【计算机科学速成课】7：中央处理器CPU</a></li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxlw94dj3hj31220mugsr.jpg" alt="image-20211221235539251"></p>
<h2 id="Chap4-处理器体系结构"><a href="#Chap4-处理器体系结构" class="headerlink" title="Chap4: 处理器体系结构"></a>Chap4: 处理器体系结构</h2><h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline??"></a>pipeline??</h3><h3 id="补充资料-2"><a href="#补充资料-2" class="headerlink" title="补充资料"></a>补充资料</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1q64y1s7MH/?spm_id_from=333.788.recommend_more_video.-1">【硬核科普】全站最硬科普：7分钟带你了解造芯全过程</a></p>
<p>Patterson演讲：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1fr4y1N7hx/">计算机体系结构的新黄金时代</a>，Hennessy演讲：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1TV411y7Jo/">计算机体系结构的新黄金时代</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV12A41177Qt?p=1">计算机体系结构（胡伟武 汪文祥）20年秋季学期</a></p>
<p>关于现代处理器，强烈推荐阅读这份很好的在线文档：<a target="_blank" rel="noopener" href="http://www.lighterra.com/papers/modernmicroprocessors/">Modern Microprocessors A 90-Minute Guide!</a><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxyktrcremj324a0r2133.jpg" alt="image-20220101231226145"></p>
<p>大学伯克利分校 CS61C：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1g5411K7Z7/">计算机架构的伟大思想</a> - 授课教授Krste</p>
<h2 id="Chap5-优化程序性能"><a href="#Chap5-优化程序性能" class="headerlink" title="Chap5: 优化程序性能"></a>Chap5: 优化程序性能</h2><p><strong>编译器领域最早成名的教材</strong>： <em>Compilers: Principles,Techniques,and Tools，</em>中文名（龙书）：<em>编译原理</em></p>
<p>本书的一大特点就是抽象难懂，主要讨论了编译器设计的重要主题，包括词法分析、语法分析、语义分析、中间代码生成、代码优化、代码生成等过程</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxtx8zt4y5j30ro0jjjug.jpg" alt="1001948-20171123164637571-2133970350_副本 (1)"></p>
<p><a target="_blank" rel="noopener" href="https://developer.51cto.com/art/202011/630677.htm">详解三大编译器：gcc、llvm 和 clang</a></p>
<p>传统的编译器通常分为三个部分，前端(frontEnd)，优化器(Optimizer)和后端(backEnd)。在编译过程中，前端主要负责词法和语法分析，将源代码转化为抽象语法树；优化器则是在前端的基础上，对得到的中间代码进行优化，使代码更加高效；后端则是将已经优化的中间代码转化为针对各自平台的机器代码。</p>
<h2 id="Chap6-存储器层次结构"><a href="#Chap6-存储器层次结构" class="headerlink" title="Chap6: 存储器层次结构"></a>Chap6: 存储器层次结构</h2><p>计算机访问不同层次存储器的时间开销：<a target="_blank" rel="noopener" href="https://colin-scott.github.io/personal_website/research/interactive_latency.html">https://colin-scott.github.io/personal_website/research/interactive_latency.html</a></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxtz52ohkkj31xp0u0aia.jpg" alt="image-20211228233954700"></p>
<ul>
<li>局部性原理</li>
</ul>
<p>时间局部性、空间局部性</p>
<p>这也是为何缓存为何会有用</p>
<ul>
<li>存储器的层次结构</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxtzey4ddvj313s0u0tf2.jpg" alt="image-20211228234920297"></p>
<p>我们来看一个真实的Intel Core i7 CPU的缓存结构示意图</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxv2as1djvj30n10hcwhd.jpg" alt="img"></p>
<p><strong>存储器山</strong>（Memory Mountain）（不同的CPU有不同的存储器山）</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxv2a2u14kj30n00hbacw.jpg" alt="img"></p>
<h2 id="Chap7-链接"><a href="#Chap7-链接" class="headerlink" title="Chap7: 链接"></a>Chap7: 链接</h2><p>进程的虚拟地址空间：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxv46lsaolj30jc0fuwg6.jpg" alt="enter image description here"></p>
<p>（视频讲座）：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1hv411s7ew/">Linux环境下：程序的链接, 装载和库</a>   （比较详细，探讨了很多细节）</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxv4mgcj1tj31qx0u0gt5.jpg" alt="image-20211229233510335"></p>
<h2 id="Chap8-异常控制流"><a href="#Chap8-异常控制流" class="headerlink" title="Chap8: 异常控制流"></a>Chap8: 异常控制流</h2><p>计算机系统中的抽象：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxv5g6a0edj30zw0f0wgc.jpg" alt="image-20211230000335624"></p>
<p>操作系统历史：类Unix操作系统的发展与演进</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxw47m038ij30ko0eydht.jpg" alt="img"></p>
<p><strong>程序 vs 进程</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxw52fywnej30nb0h2gna.jpg" alt="img"></p>
<p><strong>用户空间 vs 内核空间</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxw659bc3nj30lo0ekach.jpg" alt="img"></p>
<p>参考：<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/12/user_space_vs_kernel_space.html">阮一峰：User space 与 Kernel space</a></p>
<h3 id="补充资料-3"><a href="#补充资料-3" class="headerlink" title="补充资料"></a>补充资料</h3><p>文章：<a target="_blank" rel="noopener" href="https://liam.page/2017/01/17/layers-and-operation-system/">程序员的自我修养（二）：操作系统、进程与线程</a></p>
<h2 id="Chap9-虚拟内存"><a href="#Chap9-虚拟内存" class="headerlink" title="Chap9: 虚拟内存"></a>Chap9: 虚拟内存</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1XB4y1A7vm?p=5"><strong>物理内存有什么问题？</strong></a>    1. 内存空间不够  2. 产生内存碎片  3. 没有内存保护    </p>
<p>（虚拟内存闪亮登场，本质就是增加一个中间层，计算机科学的任何问题都可以通过增加间接层解决！）</p>
<p><strong>虚拟内存有什么优点？</strong>    1**.** 可以使用磁盘交换空间  2. 虚拟地址到物理地址映射灵活  3. 进程地址空间隔离</p>
<p>==&gt; <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/latest/source/malloc/malloc.c">glibc源码一瞥</a> （相关的补充参考资料： <a target="_blank" rel="noopener" href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/">Understanding glibc malloc</a>）</p>
<p><strong><em>*</em> 案例参考（遇到的问题 &amp; 解决的方法）</strong>：<a target="_blank" rel="noopener" href="https://paper.seebug.org/papers/Archive/refs/heap/glibc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86ptmalloc%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.pdf">阿里（华庭=庄明强）：Glibc内存管理ptmalloc源代码分析</a></p>
<h2 id="Chap10-系统级-I-O"><a href="#Chap10-系统级-I-O" class="headerlink" title="Chap10: 系统级 I/O"></a>Chap10: 系统级 I/O</h2><p><strong>学习系统I/O，标准I/O，最好的办法是：自己动手写一个终端编辑器（功能类似vim）</strong></p>
<p>可以参考Redis 的作者antirez编写的Kilo，之所以称为Kilo是因为它不到1024行的代码， 他花了几个小时就编写出了文本编辑器的原型，同时antirez表示编写该编辑器的原因很简单：<a target="_blank" rel="noopener" href="http://antirez.com/news/108">仅为了乐趣</a> 。</p>
<p>PS. 这里还有一份很棒的入门指南：<a target="_blank" rel="noopener" href="https://viewsourcecode.org/snaptoken/kilo/">Build Your Own Text Editor</a></p>
<h2 id="Chap11-网路编程"><a href="#Chap11-网路编程" class="headerlink" title="Chap11: 网路编程"></a>Chap11: 网路编程</h2><p>今天互联网中的大千世界都立足于TCP/IP协议之上，Socket甚至已经成为了网络编程的同义词。</p>
<p>Socket的英文原意为 “插孔” 或者 “插座”，通常称作”套接字”，它允许两个进程进行通信，这两个进程可能运行在同一个机器上，也可能运行在不同机器上。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxyicxi46xj316o0k0wfs.jpg" alt="img"></p>
<p>从应用程序员的角度来看，它是应用层与TCP/IP协议族通信的中间软件抽象层，是一组接口API。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxyigr4x74j314u0rkacg.jpg" alt="img"></p>
<p>提及网路编程，W. Richard Stevens对我们这些学习Unix/Linux的程序员的影响是巨大的，每每捧读他写的书都会被感动，不仅被他那丰富的知识所折服，更是被他那一丝不苟，严谨治学的态度所折服。</p>
<p>“他不清楚的，他下决心要弄明白。他知道的，他要努力传授给所有感兴趣的人们！”这就是Stevens！</p>
<p>他的个人网站至今还能访问：<a target="_blank" rel="noopener" href="http://www.kohala.com/start/%EF%BC%8C%E8%AE%A9%E6%88%91%E4%BB%AC%E5%90%91%E4%BB%96%E8%87%B4%E6%95%AC">http://www.kohala.com/start/，让我们向他致敬</a></p>
<h2 id="Chap12-并发编程"><a href="#Chap12-并发编程" class="headerlink" title="Chap12: 并发编程"></a>Chap12: 并发编程</h2><p>处理器发展的趋势：多核时代早已到来！免费的午餐已经结束了！</p>
<p>参考文章（Herb Sutter）：<a target="_blank" rel="noopener" href="http://www.gotw.ca/publications/concurrency-ddj.htm">The Free Lunch Is Over: A Fundamental Turn Toward Concurrency in Software</a></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxyjo1ksctj30nm0e0act.jpg" alt="img"></p>
<p>多核处理器成为上述变革的主流解決方案，想要压榨出更多的处理器效能，软件必须跟上硬件的设计！</p>
<ul>
<li>并发与并行</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1EN411o7FY/">【大佬讲座】谷歌大神 Rob Pike：并发 vs 并行 (傻傻分不清楚？)</a></p>
<p>Concurrency （并发）指程序架构，将程序拆成多个可独立运行的部分，不一定要同时运行，Parallelism（并行） 指程序执行，同时执行多个程序。</p>
<p>Concurrency 可能会用到 Parallelism，但不一定要用 Parallelism 才能实现 Concurrency。在 Concurrent 中，工作可拆分成「独立执行」的部份，于是「可以」让很多事情一起做，但「不一定」要真的同时做，参见下图。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxyjyjtg7sj31600hitao.jpg" alt="image-20220101224145839"></p>
<p>那么我们究竟应该如何创建一个并行程序呢？以下流程图示取自CMU：15-418 并行计算架构与编程。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxyk3hp9ifj31490u0gq7.jpg" alt="image-20220101224710564"></p>
<p>延伸阅读：</p>
<p>卡内基梅隆大学：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1aa4y1s7EH/">并行计算架构与编程 (15-418 / 15-618)</a></p>
<p>伊利诺伊大学：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1z541137iG/">异构并行编程（胡文美教授）- 重点讲解CUDA编程</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><p><a target="_blank" rel="noopener" href="https://fengmuzi2003.gitbook.io/csapp3e/">https://fengmuzi2003.gitbook.io/csapp3e/</a></p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxwa4bmaqsj32480qo101.jpg" alt="image-20211202234352970"></p>
</li>
<li><p>视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1RK4y1R7Kf?p=2&spm_id_from=pageDriver">[原创] 深入理解计算机系统 - CSAPP重点导读（更新完毕）</a><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gwzx5yb8rej31og0u011m.jpg" alt="image-20211202234515584"></p>
</li>
<li><p>官方Lab 实验：<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">http://csapp.cs.cmu.edu/3e/labs.html</a></p>
</li>
<li><p>github上相关 lab 下载：<a target="_blank" rel="noopener" href="https://github.com/Exely/CSAPP-Labs">https://github.com/Exely/CSAPP-Labs</a></p>
</li>
<li><p>知乎相关 lab 专栏：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/deeplearningcat">https://zhuanlan.zhihu.com/deeplearningcat</a>  <img src="https://tva1.sinaimg.cn/large/008i3skNgy1gx6w20frn5j31em0tidl7.jpg" alt="image-20211208233527359"></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cD4y1D7uR?p=23">【合集】CSAPP-深入理解计算机系统</a> <img src="https://tva1.sinaimg.cn/large/008i3skNgy1gxykv2epifj31rs0r2q8r.jpg" alt="image-20220101231341901"></p>
</li>
<li></li>
</ol>
</div></article></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2021/11/21/%E3%80%90%E7%BC%96%E7%A8%8B%E3%80%91%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BE/" title="⭐️玩转树莓派" class="prev">PREV</a><a href="/2021/10/21/%E3%80%90%E7%BC%96%E7%A8%8B%E3%80%91c%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/" title="⭐️c语言学习" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2022 <a target="_blank">John Doe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p> <span style="padding-right: 6px;">闽ICP备16007301号-2</span></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/jquery-1.8.2.min.js"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/articleCatalog.js"></script><script src="https://bubuzou.oss-cn-shenzhen.aliyuncs.com/blog/202010/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>